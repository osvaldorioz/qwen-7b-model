#!/bin/bash
set -e
set -x  # Enable debug output

# Version 1.4 for Ollama Server (qwen-7b-model)

# Ensure required commands are available
command -v python3 >/dev/null 2>&1 || { echo "python3 is not installed"; exit 1; }

# Change to source directory
cd /tmp/src

# List contents of /tmp/src for debugging
echo "Contents of /tmp/src:"
ls -la /tmp/src

# Create directories in user-writable location
mkdir -p /opt/app-root/bin
mkdir -p /opt/app-root/models

# Copy pre-downloaded Ollama binary to user-writable location
echo "Copying pre-downloaded Ollama binary..."
cp -v /tmp/src/bin/ollama /opt/app-root/bin/ollama
chmod +x /opt/app-root/bin/ollama

# Recombine the split models.zip files if not already recombined
if [ ! -f "/tmp/models.zip" ]; then
    echo "Recombining models.zip from parts..."
    cat /tmp/src/models.zip.part* > /tmp/models.zip || {
        echo "Error: No se pudo recombinar models.zip"
        exit 1
    }
fi

# Extract models.zip using Python to user-writable location
echo "Extracting models.zip to /opt/app-root/models using Python..."
python3 - <<EOF
import zipfile
import os

zip_path = "/tmp/models.zip"
extract_path = "/opt/app-root/models"

try:
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_path)
    print("Successfully extracted models.zip to /opt/app-root/models")
except Exception as e:
    print(f"Error: No se pudo extraer models.zip: {e}")
    exit(1)
EOF

# Verify extraction
if [ ! -f "/opt/app-root/models/blobs/sha256-a99b7f834d754b88f122d865f32758ba9f0994a83f8363df2c1e71c17605a025" ]; then
    echo "Error: Blob sha256-a99b7f834d754b88f122d865f32758ba9f0994a83f8363df2c1e71c17605a025 not found after extraction"
    ls -la /opt/app-root/models
    exit 1
fi

# Verify Ollama binary
echo "Verifying Ollama binary..."
/opt/app-root/bin/ollama --version || { echo "Ollama binary not working"; exit 1; }

# Set environment variable for Ollama to use custom model path
export OLLAMA_MODELS=/opt/app-root/models

# Verify model
echo "Verifying Qwen2.5-VL:7b model..."
/opt/app-root/bin/ollama list | grep qwen2.5vl:7b || { echo "Model qwen2.5vl:7b not found"; exit 1; }

# Set permissions for /opt/app-root/models and /opt/app-root/bin
chmod -R u+rw /opt/app-root/models /opt/app-root/bin

echo "Assemble completed successfully."
